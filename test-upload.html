<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Upload CGPlayerWeb</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 600px; margin: 0 auto; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, button { width: 100%; padding: 10px; margin: 5px 0; border-radius: 4px; border: none; }
        input[type="file"] { background: #333; color: #fff; }
        button { background: #007ACC; color: white; cursor: pointer; }
        button:hover { background: #005a9a; }
        .result { background: #2a2a2a; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Test de Upload - CGPlayerWeb</h1>
        
        <form id="uploadForm">
            <div class="form-group">
                <label for="title">T√≠tulo:</label>
                <input type="text" id="title" value="Test Song" required>
            </div>
            
            <div class="form-group">
                <label for="files">Archivos de Audio:</label>
                <input type="file" id="files" multiple accept="audio/*" required>
            </div>
            
            <button type="submit">üì§ Subir Archivos</button>
        </form>
        
        <div id="results"></div>
    </div>

    <script>
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const results = document.getElementById('results');
            results.innerHTML = '<div class="result">üîÑ Subiendo archivos...</div>';
            
            const title = document.getElementById('title').value;
            const files = document.getElementById('files').files;
            
            if (files.length === 0) {
                results.innerHTML = '<div class="result error">‚ùå Selecciona al menos un archivo</div>';
                return;
            }
            
            // Primero hacer login
            try {
                const loginResponse = await fetch('http://localhost:3001/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@chilegospel.com',
                        password: 'admin123'
                    })
                });
                
                if (!loginResponse.ok) {
                    throw new Error('Login fall√≥');
                }
                
                const loginData = await loginResponse.json();
                const token = loginData.token;
                
                // Crear FormData
                const formData = new FormData();
                formData.append('title', title);
                formData.append('artist', 'Test Artist');
                formData.append('album', 'Test Album');
                formData.append('genre', 'Gospel');
                
                // Crear voice assignments simple
                const voiceAssignments = Array.from(files).map((file, index) => ({
                    filename: file.name,
                    voiceType: ['SOPRANO', 'CONTRALTO', 'TENOR', 'BARITONE', 'BASS'][index % 5]
                }));
                formData.append('voiceAssignments', JSON.stringify(voiceAssignments));
                
                // Agregar archivos
                Array.from(files).forEach(file => {
                    formData.append('audio', file);
                });
                
                console.log('Enviando:', { title, filesCount: files.length, voiceAssignments });
                
                // Subir archivos
                const uploadResponse = await fetch('http://localhost:3001/api/songs/multi-upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const result = await uploadResponse.json();
                
                if (uploadResponse.ok) {
                    results.innerHTML = `
                        <div class="result success">
                            ‚úÖ Upload exitoso!<br>
                            Canciones creadas: ${result.songs?.length || 'N/A'}<br>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    results.innerHTML = `
                        <div class="result error">
                            ‚ùå Error en upload:<br>
                            ${result.message || 'Error desconocido'}<br>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;
                }
                
            } catch (error) {
                results.innerHTML = `
                    <div class="result error">
                        ‚ùå Error: ${error.message}<br>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
