<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Connection - CGPlayerWeb</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #1a1a1a; 
            color: #fff; 
        }
        .container { max-width: 600px; margin: 0 auto; }
        .test-item { 
            background: #2a2a2a; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border-left: 4px solid #555;
        }
        .success { border-left-color: #4CAF50; }
        .error { border-left-color: #f44336; }
        .loading { border-left-color: #2196F3; }
        button { 
            background: #007ACC; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #005a9a; }
        .status { font-weight: bold; }
        .details { font-size: 0.9em; color: #ccc; margin-top: 5px; }
        .url { background: #333; padding: 5px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç CGPlayerWeb - Diagn√≥stico de Conectividad</h1>
        
        <div class="test-item">
            <strong>üåê URL del Frontend:</strong> <span class="url" id="frontendUrl"></span><br>
            <strong>üîß URL del Backend:</strong> <span class="url" id="backendUrl"></span>
        </div>

        <button onclick="runAllTests()">üöÄ Ejecutar Todas las Pruebas</button>
        <button onclick="clearResults()">üßπ Limpiar</button>

        <div id="results"></div>

        <div class="test-item">
            <h3>üì± Instrucciones para dispositivos m√≥viles:</h3>
            <ol>
                <li>Conecta tu m√≥vil a la misma red WiFi</li>
                <li>Abre esta p√°gina en tu m√≥vil: <span class="url" id="mobileUrl"></span></li>
                <li>Ejecuta las pruebas desde el m√≥vil</li>
                <li>Si falla, verifica que el firewall est√© configurado correctamente</li>
            </ol>
        </div>
    </div>

    <script>
        // Detectar URLs autom√°ticamente
        const hostname = window.location.hostname;
        const protocol = window.location.protocol;
        const frontendPort = '5173';
        const backendPort = '3001';
        
        const frontendUrl = `${protocol}//${hostname}:${frontendPort}`;
        const backendUrl = `${protocol}//${hostname}:${backendPort}/api`;
        const mobileUrl = `http://${hostname}:${frontendPort}/diagnostico-completo.html`;
        
        document.getElementById('frontendUrl').textContent = frontendUrl;
        document.getElementById('backendUrl').textContent = backendUrl;
        document.getElementById('mobileUrl').textContent = mobileUrl;

        function addResult(title, status, details = '') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-item ${status}`;
            div.innerHTML = `
                <div class="status">${title}</div>
                <div class="details">${details}</div>
            `;
            results.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function testConnection(url, name) {
            addResult(`üîÑ Probando ${name}...`, 'loading', `URL: ${url}`);
            
            try {
                const startTime = Date.now();
                const response = await fetch(url, {
                    method: 'GET',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                if (response.ok) {
                    const data = await response.text();
                    addResult(
                        `‚úÖ ${name} - Conectado`, 
                        'success', 
                        `Status: ${response.status} | Tiempo: ${responseTime}ms | Respuesta: ${data.substring(0, 100)}...`
                    );
                    return true;
                } else {
                    addResult(
                        `‚ùå ${name} - Error HTTP`, 
                        'error', 
                        `Status: ${response.status} ${response.statusText} | Tiempo: ${responseTime}ms`
                    );
                    return false;
                }
            } catch (error) {
                addResult(
                    `‚ùå ${name} - Error de Conexi√≥n`, 
                    'error', 
                    `Error: ${error.message}`
                );
                return false;
            }
        }

        async function testAuth() {
            const loginUrl = `${backendUrl}/auth/login`;
            addResult(`üîë Probando autenticaci√≥n...`, 'loading', `URL: ${loginUrl}`);
            
            try {
                const response = await fetch(loginUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'admin@chilegospel.com',
                        password: 'admin123'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addResult(
                        `‚úÖ Autenticaci√≥n - Funcionando`, 
                        'success', 
                        `Usuario: ${data.user?.name || 'Admin'} | Token recibido`
                    );
                    return data.token;
                } else {
                    const errorData = await response.text();
                    addResult(
                        `‚ùå Autenticaci√≥n - Fall√≥`, 
                        'error', 
                        `Status: ${response.status} | Error: ${errorData}`
                    );
                    return null;
                }
            } catch (error) {
                addResult(
                    `‚ùå Autenticaci√≥n - Error de Conexi√≥n`, 
                    'error', 
                    `Error: ${error.message}`
                );
                return null;
            }
        }

        async function runAllTests() {
            clearResults();
            
            addResult('üéØ Iniciando diagn√≥stico completo...', 'loading', new Date().toLocaleString());
            
            // Test 1: Ping al backend
            await testConnection(`${backendUrl}/ping`, 'Backend Ping');
            
            // Test 2: Health check
            await testConnection(`${backendUrl}/health`, 'Backend Health');
            
            // Test 3: Frontend (si est√° disponible)
            await testConnection(frontendUrl, 'Frontend');
            
            // Test 4: Autenticaci√≥n
            const token = await testAuth();
            
            // Test 5: API con autenticaci√≥n (si tenemos token)
            if (token) {
                try {
                    const response = await fetch(`${backendUrl}/users/profile`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const userData = await response.json();
                        addResult(
                            '‚úÖ API Autenticada - Funcionando', 
                            'success', 
                            `Perfil obtenido: ${userData.name} (${userData.email})`
                        );
                    } else {
                        addResult('‚ùå API Autenticada - Error', 'error', `Status: ${response.status}`);
                    }
                } catch (error) {
                    addResult('‚ùå API Autenticada - Error de Conexi√≥n', 'error', error.message);
                }
            }
            
            addResult('üèÅ Diagn√≥stico completado', 'success', 'Revisa los resultados arriba');
        }

        // Ejecutar prueba b√°sica al cargar
        window.onload = () => {
            addResult('üåü P√°gina cargada correctamente', 'success', `Navegador: ${navigator.userAgent.substring(0, 50)}...`);
        };
    </script>
</body>
</html>
